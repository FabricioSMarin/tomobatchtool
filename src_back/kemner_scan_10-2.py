#!/APSshare/anaconda/x86_64/bin/python

import epics
from epics import caput, caget
from epics import PV
import time
import numpy as np

'''
please enter the scan prameters below:
scans [x-center(um), y-center.(um), x-width.(um), y-width.(um), x-stepsize.(um), Y-stepsize.(um), dwell.(ms)]
'''

scans = [
        [5.609, 11.432, -89.500, 0.306, 0.01, 0.001, 0.001, 100],
        [5.606, 11.432, -88.500, 0.3127, 0.01, 0.001, 0.001, 100],
        [5.604, 11.432, -87.500, 0.3193, 0.01, 0.001, 0.001, 100],
        [5.603, 11.432, -86.500, 0.326, 0.01, 0.001, 0.001, 100],
        [5.601, 11.432, -85.500, 0.3327, 0.01, 0.001, 0.001, 100],
        [5.598, 11.432, -84.500, 0.3393, 0.01, 0.001, 0.001, 100],
        [5.596, 11.432, -83.500, 0.346, 0.01, 0.001, 0.001, 100],
        [5.595, 11.432, -82.500, 0.3527, 0.01, 0.001, 0.001, 100],
        [5.593, 11.432, -81.500, 0.3593, 0.01, 0.001, 0.001, 100],
        [5.590, 11.432, -80.500, 0.366, 0.01, 0.001, 0.001, 100],
        [5.591, 11.432, -79.500, 0.3771, 0.01, 0.001, 0.001, 100],
        [5.591, 11.432, -78.500, 0.3882, 0.01, 0.001, 0.001, 100],
        [5.591, 11.432, -77.500, 0.3993, 0.01, 0.001, 0.001, 100],
        [5.591, 11.432, -76.500, 0.4104, 0.01, 0.001, 0.001, 100],
        [5.592, 11.432, -75.500, 0.4216, 0.01, 0.001, 0.001, 100],
        [5.592, 11.432, -74.500, 0.4327, 0.01, 0.001, 0.001, 100],
        [5.592, 11.432, -73.500, 0.4438, 0.01, 0.001, 0.001, 100],
        [5.592, 11.432, -72.500, 0.4549, 0.01, 0.001, 0.001, 100],
        [5.593, 11.432, -71.500, 0.466, 0.01, 0.001, 0.001, 100],
        [5.591, 11.432, -70.500, 0.4727, 0.01, 0.001, 0.001, 100],
        [5.590, 11.432, -69.500, 0.4793, 0.01, 0.001, 0.001, 100],
        [5.588, 11.432, -68.500, 0.486, 0.01, 0.001, 0.001, 100],
        [5.587, 11.432, -67.500, 0.4927, 0.01, 0.001, 0.001, 100],
        [5.586, 11.432, -66.500, 0.4993, 0.01, 0.001, 0.001, 100],
        [5.585, 11.432, -65.500, 0.506, 0.01, 0.001, 0.001, 100],
        [5.583, 11.432, -64.500, 0.5127, 0.01, 0.001, 0.001, 100],
        [5.582, 11.432, -63.500, 0.5193, 0.01, 0.001, 0.001, 100],
        [5.580, 11.432, -62.500, 0.526, 0.01, 0.001, 0.001, 100],
        [5.580, 11.432, -61.500, 0.5347, 0.01, 0.001, 0.001, 100],
        [5.580, 11.432, -60.500, 0.5433, 0.01, 0.001, 0.001, 100],
        [5.580, 11.432, -59.500, 0.552, 0.01, 0.001, 0.001, 100],
        [5.580, 11.432, -58.500, 0.5607, 0.01, 0.001, 0.001, 100],
        [5.580, 11.432, -57.500, 0.5693, 0.01, 0.001, 0.001, 100],
        [5.580, 11.432, -56.500, 0.578, 0.01, 0.001, 0.001, 100],
        [5.580, 11.432, -55.500, 0.5867, 0.01, 0.001, 0.001, 100],
        [5.580, 11.432, -54.500, 0.5953, 0.01, 0.001, 0.001, 100],
        [5.580, 11.432, -53.500, 0.604, 0.01, 0.001, 0.001, 100],
        [5.579, 11.432, -52.500, 0.6118, 0.01, 0.001, 0.001, 100],
        [5.578, 11.432, -51.500, 0.6196, 0.01, 0.001, 0.001, 100],
        [5.578, 11.432, -50.500, 0.6273, 0.01, 0.001, 0.001, 100],
        [5.577, 11.432, -49.500, 0.6351, 0.01, 0.001, 0.001, 100],
        [5.577, 11.432, -48.500, 0.6429, 0.01, 0.001, 0.001, 100],
        [5.576, 11.432, -47.500, 0.6507, 0.01, 0.001, 0.001, 100],
        [5.576, 11.432, -46.500, 0.6584, 0.01, 0.001, 0.001, 100],
        [5.575, 11.432, -45.500, 0.6662, 0.01, 0.001, 0.001, 100],
        [5.574, 11.432, -44.500, 0.674, 0.01, 0.001, 0.001, 100],
        [5.575, 11.432, -43.500, 0.6776, 0.01, 0.001, 0.001, 100],
        [5.575, 11.432, -42.500, 0.6811, 0.01, 0.001, 0.001, 100],
        [5.575, 11.432, -41.500, 0.6847, 0.01, 0.001, 0.001, 100],
        [5.575, 11.432, -40.500, 0.6882, 0.01, 0.001, 0.001, 100],
        [5.576, 11.432, -39.500, 0.6918, 0.01, 0.001, 0.001, 100],
        [5.576, 11.432, -38.500, 0.6953, 0.01, 0.001, 0.001, 100],
        [5.576, 11.432, -37.500, 0.6989, 0.01, 0.001, 0.001, 100],
        [5.576, 11.432, -36.500, 0.7024, 0.01, 0.001, 0.001, 100],
        [5.577, 11.432, -35.500, 0.706, 0.01, 0.001, 0.001, 100],
        [5.576, 11.432, -34.500, 0.7084, 0.01, 0.001, 0.001, 100],
        [5.575, 11.432, -33.500, 0.7109, 0.01, 0.001, 0.001, 100],
        [5.574, 11.432, -32.500, 0.7133, 0.01, 0.001, 0.001, 100],
        [5.573, 11.432, -31.500, 0.7158, 0.01, 0.001, 0.001, 100],
        [5.573, 11.432, -30.500, 0.7182, 0.01, 0.001, 0.001, 100],
        [5.572, 11.432, -29.500, 0.7207, 0.01, 0.001, 0.001, 100],
        [5.571, 11.432, -28.500, 0.7231, 0.01, 0.001, 0.001, 100],
        [5.570, 11.432, -27.500, 0.7256, 0.01, 0.001, 0.001, 100],
        [5.569, 11.432, -26.500, 0.728, 0.01, 0.001, 0.001, 100],
        [5.569, 11.432, -25.500, 0.7291, 0.01, 0.001, 0.001, 100],
        [5.568, 11.432, -24.500, 0.7302, 0.01, 0.001, 0.001, 100],
        [5.568, 11.432, -23.500, 0.7313, 0.01, 0.001, 0.001, 100],
        [5.567, 11.432, -22.500, 0.7324, 0.01, 0.001, 0.001, 100],
        [5.567, 11.432, -21.500, 0.7336, 0.01, 0.001, 0.001, 100],
        [5.566, 11.432, -20.500, 0.7347, 0.01, 0.001, 0.001, 100],
        [5.566, 11.432, -19.500, 0.7358, 0.01, 0.001, 0.001, 100],
        [5.565, 11.432, -18.500, 0.7369, 0.01, 0.001, 0.001, 100],
        [5.564, 11.432, -17.500, 0.738, 0.01, 0.001, 0.001, 100],
        [5.565, 11.432, -16.500, 0.7373, 0.01, 0.001, 0.001, 100],
        [5.565, 11.432, -15.500, 0.7367, 0.01, 0.001, 0.001, 100],
        [5.566, 11.432, -14.500, 0.736, 0.01, 0.001, 0.001, 100],
        [5.566, 11.432, -13.500, 0.7353, 0.01, 0.001, 0.001, 100],
        [5.566, 11.432, -12.500, 0.7347, 0.01, 0.001, 0.001, 100],
        [5.566, 11.432, -11.500, 0.734, 0.01, 0.001, 0.001, 100],
        [5.567, 11.432, -10.500, 0.7333, 0.01, 0.001, 0.001, 100],
        [5.567, 11.432, -9.500, 0.7327, 0.01, 0.001, 0.001, 100],
        [5.567, 11.432, -8.500, 0.732, 0.01, 0.001, 0.001, 100],
        [5.568, 11.432, -7.500, 0.7313, 0.01, 0.001, 0.001, 100],
        [5.568, 11.432, -6.500, 0.7307, 0.01, 0.001, 0.001, 100],
        [5.568, 11.432, -5.500, 0.73, 0.01, 0.001, 0.001, 100],
        [5.568, 11.432, -4.500, 0.7293, 0.01, 0.001, 0.001, 100],
        [5.568, 11.432, -3.500, 0.7287, 0.01, 0.001, 0.001, 100],
        [5.568, 11.432, -2.500, 0.728, 0.01, 0.001, 0.001, 100],
        [5.568, 11.432, -1.500, 0.7273, 0.01, 0.001, 0.001, 100],
        [5.568, 11.432, -0.500, 0.7267, 0.01, 0.001, 0.001, 100],
        [5.569, 11.432, 0.500, 0.726, 0.01, 0.001, 0.001, 100],
        [5.569, 11.432, 1.500, 0.7222, 0.01, 0.001, 0.001, 100],
        [5.569, 11.432, 2.500, 0.7184, 0.01, 0.001, 0.001, 100],
        [5.569, 11.432, 3.500, 0.7147, 0.01, 0.001, 0.001, 100],
        [5.569, 11.432, 4.500, 0.7109, 0.01, 0.001, 0.001, 100],
        [5.569, 11.432, 5.500, 0.7071, 0.01, 0.001, 0.001, 100],
        [5.569, 11.432, 6.500, 0.7033, 0.01, 0.001, 0.001, 100],
        [5.569, 11.432, 7.500, 0.6996, 0.01, 0.001, 0.001, 100],
        [5.569, 11.432, 8.500, 0.6958, 0.01, 0.001, 0.001, 100],
        [5.569, 11.432, 9.500, 0.692, 0.01, 0.001, 0.001, 100],
        [5.569, 11.432, 10.500, 0.6871, 0.01, 0.001, 0.001, 100],
        [5.569, 11.432, 11.500, 0.6822, 0.01, 0.001, 0.001, 100],
        [5.569, 11.432, 12.500, 0.6773, 0.01, 0.001, 0.001, 100],
        [5.569, 11.432, 13.500, 0.6724, 0.01, 0.001, 0.001, 100],
        [5.568, 11.432, 14.500, 0.6676, 0.01, 0.001, 0.001, 100],
        [5.568, 11.432, 15.500, 0.6627, 0.01, 0.001, 0.001, 100],
        [5.568, 11.432, 16.500, 0.6578, 0.01, 0.001, 0.001, 100],
        [5.568, 11.432, 17.500, 0.6529, 0.01, 0.001, 0.001, 100],
        [5.567, 11.432, 18.500, 0.648, 0.01, 0.001, 0.001, 100],
        [5.568, 11.432, 19.500, 0.6422, 0.01, 0.001, 0.001, 100],
        [5.569, 11.432, 20.500, 0.6364, 0.01, 0.001, 0.001, 100],
        [5.570, 11.432, 21.500, 0.6307, 0.01, 0.001, 0.001, 100],
        [5.571, 11.432, 22.500, 0.6249, 0.01, 0.001, 0.001, 100],
        [5.572, 11.432, 23.500, 0.6191, 0.01, 0.001, 0.001, 100],
        [5.573, 11.432, 24.500, 0.6133, 0.01, 0.001, 0.001, 100],
        [5.574, 11.432, 25.500, 0.6076, 0.01, 0.001, 0.001, 100],
        [5.575, 11.432, 26.500, 0.6018, 0.01, 0.001, 0.001, 100],
        [5.575, 11.432, 27.500, 0.596, 0.01, 0.001, 0.001, 100],
        [5.577, 11.432, 28.500, 0.5896, 0.01, 0.001, 0.001, 100],
        [5.577, 11.432, 29.500, 0.5831, 0.01, 0.001, 0.001, 100],
        [5.579, 11.432, 30.500, 0.5767, 0.01, 0.001, 0.001, 100],
        [5.580, 11.432, 31.500, 0.5702, 0.01, 0.001, 0.001, 100],
        [5.580, 11.432, 32.500, 0.5638, 0.01, 0.001, 0.001, 100],
        [5.582, 11.432, 33.500, 0.5573, 0.01, 0.001, 0.001, 100],
        [5.582, 11.432, 34.500, 0.5509, 0.01, 0.001, 0.001, 100],
        [5.583, 11.432, 35.500, 0.5444, 0.01, 0.001, 0.001, 100],
        [5.585, 11.432, 36.500, 0.538, 0.01, 0.001, 0.001, 100],
        [5.586, 11.432, 37.500, 0.5309, 0.01, 0.001, 0.001, 100],
        [5.587, 11.432, 38.500, 0.5238, 0.01, 0.001, 0.001, 100],
        [5.588, 11.432, 39.500, 0.5167, 0.01, 0.001, 0.001, 100],
        [5.589, 11.432, 40.500, 0.5096, 0.01, 0.001, 0.001, 100],
        [5.590, 11.432, 41.500, 0.5024, 0.01, 0.001, 0.001, 100],
        [5.591, 11.432, 42.500, 0.4953, 0.01, 0.001, 0.001, 100],
        [5.592, 11.432, 43.500, 0.4882, 0.01, 0.001, 0.001, 100],
        [5.593, 11.432, 44.500, 0.4811, 0.01, 0.001, 0.001, 100],
        [5.595, 11.432, 45.500, 0.474, 0.01, 0.001, 0.001, 100],
        [5.596, 11.432, 46.500, 0.4671, 0.01, 0.001, 0.001, 100],
        [5.598, 11.432, 47.500, 0.4602, 0.01, 0.001, 0.001, 100],
        [5.599, 11.432, 48.500, 0.4533, 0.01, 0.001, 0.001, 100],
        [5.601, 11.432, 49.500, 0.4464, 0.01, 0.001, 0.001, 100],
        [5.603, 11.432, 50.500, 0.4396, 0.01, 0.001, 0.001, 100],
        [5.604, 11.432, 51.500, 0.4327, 0.01, 0.001, 0.001, 100],
        [5.606, 11.432, 52.500, 0.4258, 0.01, 0.001, 0.001, 100],
        [5.608, 11.432, 53.500, 0.4189, 0.01, 0.001, 0.001, 100],
        [5.609, 11.432, 54.500, 0.412, 0.01, 0.001, 0.001, 100],
        [5.608, 11.432, 55.500, 0.4056, 0.01, 0.001, 0.001, 100],
        [5.606, 11.432, 56.500, 0.3991, 0.01, 0.001, 0.001, 100],
        [5.604, 11.432, 57.500, 0.3927, 0.01, 0.001, 0.001, 100],
        [5.603, 11.432, 58.500, 0.3862, 0.01, 0.001, 0.001, 100],
        [5.601, 11.432, 59.500, 0.3798, 0.01, 0.001, 0.001, 100],
        [5.599, 11.432, 60.500, 0.3733, 0.01, 0.001, 0.001, 100],
        [5.598, 11.432, 61.500, 0.3669, 0.01, 0.001, 0.001, 100],
        [5.596, 11.432, 62.500, 0.3604, 0.01, 0.001, 0.001, 100],
        [5.595, 11.432, 63.500, 0.354, 0.01, 0.001, 0.001, 100],
        [5.593, 11.432, 64.500, 0.3522, 0.01, 0.001, 0.001, 100],
        [5.591, 11.432, 65.500, 0.3504, 0.01, 0.001, 0.001, 100],
        [5.589, 11.432, 66.500, 0.3487, 0.01, 0.001, 0.001, 100],
        [5.587, 11.432, 67.500, 0.3469, 0.01, 0.001, 0.001, 100],
        [5.586, 11.432, 68.500, 0.3451, 0.01, 0.001, 0.001, 100],
        [5.584, 11.432, 69.500, 0.3433, 0.01, 0.001, 0.001, 100],
        [5.582, 11.432, 70.500, 0.3416, 0.01, 0.001, 0.001, 100],
        [5.580, 11.432, 71.500, 0.3398, 0.01, 0.001, 0.001, 100],
        [5.579, 11.432, 72.500, 0.338, 0.01, 0.001, 0.001, 100],
        [5.575, 11.432, 73.500, 0.3356, 0.01, 0.001, 0.001, 100],
        [5.572, 11.432, 74.500, 0.3331, 0.01, 0.001, 0.001, 100],
        [5.569, 11.432, 75.500, 0.3307, 0.01, 0.001, 0.001, 100],
        [5.566, 11.432, 76.500, 0.3282, 0.01, 0.001, 0.001, 100],
        [5.564, 11.432, 77.500, 0.3258, 0.01, 0.001, 0.001, 100],
        [5.561, 11.432, 78.500, 0.3233, 0.01, 0.001, 0.001, 100],
        [5.558, 11.432, 79.500, 0.3209, 0.01, 0.001, 0.001, 100],
        [5.554, 11.432, 80.500, 0.3184, 0.01, 0.001, 0.001, 100],
        [5.551, 11.432, 81.500, 0.316, 0.01, 0.001, 0.001, 100],
        [5.549, 11.432, 82.500, 0.3158, 0.01, 0.001, 0.001, 100],
        [5.547, 11.432, 83.500, 0.3156, 0.01, 0.001, 0.001, 100],
        [5.545, 11.432, 84.500, 0.3153, 0.01, 0.001, 0.001, 100],
        [5.543, 11.432, 85.500, 0.3151, 0.01, 0.001, 0.001, 100],
        [5.541, 11.432, 86.500, 0.3149, 0.01, 0.001, 0.001, 100],
        [5.539, 11.432, 87.500, 0.3147, 0.01, 0.001, 0.001, 100],
        [5.537, 11.432, 88.500, 0.3144, 0.01, 0.001, 0.001, 100],
        [5.535, 11.432, 89.500, 0.3142, 0.01, 0.001, 0.001, 100],
        [5.532, 11.432, 90.500, 0.314, 0.01, 0.001, 0.001, 100],

]

pvs = ['2xfm:m24.VAL', '2xfm:m13.VAL', '2xfm:m58.VAL', '2xfm:FscanH.P1WD',
       '2xfm:Fscan1.P1WD', '2xfm:FscanH.P1SI', '2xfm:Fscan1.P1SI', '2xfm:Flyscans:Setup:DwellTime.VAL']

sample_x = PV('2xfm:m24.VAL')
sample_x_rbv = PV('2xfm:m24.RBV')
sample_y = PV('2xfm:m13.VAL')
sample_y_rbv = PV('2xfm:m13.RBV')

print('Batchscan starts')

for batch_num, scan in enumerate(scans):

    print('entering scan parameters for scan #{0:d}'.format(batch_num + 1))
    for i, pvs1 in enumerate(pvs):
        print ('Setting %s' % pvs1)
        caput(pvs1, scans[batch_num][i])
        time.sleep(1.)

    # check whether the motors have moved to the requested position
    print('checking whether motors are in position')
    ready = abs(sample_x_rbv.get() - sample_x.get()) < 0.1 and abs(sample_y_rbv.get() - sample_y.get()) < 0.1
    while not ready:
        print('\t Motors are not ready')
        sample_x.put(sample_x.get())
        sample_y.put(sample_y.get())
        time.sleep(3.)
        ready = abs(sample_x_rbv.get() - sample_x.get()) < 0.1 and abs(
            sample_y_rbv.get() - sample_y.get()) < 0.1
    print('\t Motors are ready now!')

    caput('2xfm:Fscan1.EXSC', 1)
    time.sleep(1.)
    done = False
    print('Checking every 10 sec for scan to complete')

    while not done:
        done = caget('2xfm:Fscan1.EXSC') == 0
        print('\t Batch {0:d}/{1:d} scan is ongoing'.format(batch_num + 1, len(scans)))
        time.sleep(10.)

print('Completeted. Congratulations!')
