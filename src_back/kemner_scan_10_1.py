#!/APSshare/anaconda/x86_64/bin/python

import epics
from epics import caput, caget
from epics import PV
import time
import numpy as np

'''
please enter the scan prameters below:
scans [x-center(um), y-center.(um), x-width.(um), y-width.(um), x-stepsize.(um), Y-stepsize.(um), dwell.(ms)]
'''

scans = [
        [5.607, 11.432, -90.000, 0.308, 0.01, 0.001, 0.001, 100],
        [5.606, 11.432, -89.000, 0.3149, 0.01, 0.001, 0.001, 100],
        [5.604, 11.432, -88.000, 0.3218, 0.01, 0.001, 0.001, 100],
        [5.603, 11.432, -87.000, 0.3287, 0.01, 0.001, 0.001, 100],
        [5.601, 11.432, -86.000, 0.3356, 0.01, 0.001, 0.001, 100],
        [5.599, 11.432, -85.000, 0.3424, 0.01, 0.001, 0.001, 100],
        [5.598, 11.432, -84.000, 0.3493, 0.01, 0.001, 0.001, 100],
        [5.596, 11.432, -83.000, 0.3562, 0.01, 0.001, 0.001, 100],
        [5.594, 11.432, -82.000, 0.3631, 0.01, 0.001, 0.001, 100],
        [5.593, 11.432, -81.000, 0.37, 0.01, 0.001, 0.001, 100],
        [5.588, 11.432, -80.000, 0.3851, 0.01, 0.001, 0.001, 100],
        [5.583, 11.432, -79.000, 0.4002, 0.01, 0.001, 0.001, 100],
        [5.579, 11.432, -78.000, 0.4153, 0.01, 0.001, 0.001, 100],
        [5.574, 11.432, -77.000, 0.4304, 0.01, 0.001, 0.001, 100],
        [5.569, 11.432, -76.000, 0.4456, 0.01, 0.001, 0.001, 100],
        [5.564, 11.432, -75.000, 0.4607, 0.01, 0.001, 0.001, 100],
        [5.560, 11.432, -74.000, 0.4758, 0.01, 0.001, 0.001, 100],
        [5.555, 11.432, -73.000, 0.4909, 0.01, 0.001, 0.001, 100],
        [5.551, 11.432, -72.000, 0.506, 0.01, 0.001, 0.001, 100],
        [5.553, 11.432, -71.000, 0.5116, 0.01, 0.001, 0.001, 100],
        [5.555, 11.432, -70.000, 0.5171, 0.01, 0.001, 0.001, 100],
        [5.557, 11.432, -69.000, 0.5227, 0.01, 0.001, 0.001, 100],
        [5.559, 11.432, -68.000, 0.5282, 0.01, 0.001, 0.001, 100],
        [5.561, 11.432, -67.000, 0.5338, 0.01, 0.001, 0.001, 100],
        [5.563, 11.432, -66.000, 0.5393, 0.01, 0.001, 0.001, 100],
        [5.565, 11.432, -65.000, 0.5449, 0.01, 0.001, 0.001, 100],
        [5.567, 11.432, -64.000, 0.5504, 0.01, 0.001, 0.001, 100],
        [5.569, 11.432, -63.000, 0.556, 0.01, 0.001, 0.001, 100],
        [5.571, 11.432, -62.000, 0.5602, 0.01, 0.001, 0.001, 100],
        [5.572, 11.432, -61.000, 0.5644, 0.01, 0.001, 0.001, 100],
        [5.573, 11.432, -60.000, 0.5687, 0.01, 0.001, 0.001, 100],
        [5.574, 11.432, -59.000, 0.5729, 0.01, 0.001, 0.001, 100],
        [5.576, 11.432, -58.000, 0.5771, 0.01, 0.001, 0.001, 100],
        [5.577, 11.432, -57.000, 0.5813, 0.01, 0.001, 0.001, 100],
        [5.578, 11.432, -56.000, 0.5856, 0.01, 0.001, 0.001, 100],
        [5.579, 11.432, -55.000, 0.5898, 0.01, 0.001, 0.001, 100],
        [5.580, 11.432, -54.000, 0.594, 0.01, 0.001, 0.001, 100],
        [5.580, 11.432, -53.000, 0.6007, 0.01, 0.001, 0.001, 100],
        [5.580, 11.432, -52.000, 0.6073, 0.01, 0.001, 0.001, 100],
        [5.579, 11.432, -51.000, 0.614, 0.01, 0.001, 0.001, 100],
        [5.579, 11.432, -50.000, 0.6207, 0.01, 0.001, 0.001, 100],
        [5.578, 11.432, -49.000, 0.6273, 0.01, 0.001, 0.001, 100],
        [5.578, 11.432, -48.000, 0.634, 0.01, 0.001, 0.001, 100],
        [5.577, 11.432, -47.000, 0.6407, 0.01, 0.001, 0.001, 100],
        [5.577, 11.432, -46.000, 0.6473, 0.01, 0.001, 0.001, 100],
        [5.577, 11.432, -45.000, 0.654, 0.01, 0.001, 0.001, 100],
        [5.576, 11.432, -44.000, 0.6602, 0.01, 0.001, 0.001, 100],
        [5.576, 11.432, -43.000, 0.6664, 0.01, 0.001, 0.001, 100],
        [5.576, 11.432, -42.000, 0.6727, 0.01, 0.001, 0.001, 100],
        [5.576, 11.432, -41.000, 0.6789, 0.01, 0.001, 0.001, 100],
        [5.575, 11.432, -40.000, 0.6851, 0.01, 0.001, 0.001, 100],
        [5.575, 11.432, -39.000, 0.6913, 0.01, 0.001, 0.001, 100],
        [5.575, 11.432, -38.000, 0.6976, 0.01, 0.001, 0.001, 100],
        [5.575, 11.432, -37.000, 0.7038, 0.01, 0.001, 0.001, 100],
        [5.574, 11.432, -36.000, 0.71, 0.01, 0.001, 0.001, 100],
        [5.574, 11.432, -35.000, 0.7124, 0.01, 0.001, 0.001, 100],
        [5.573, 11.432, -34.000, 0.7149, 0.01, 0.001, 0.001, 100],
        [5.572, 11.432, -33.000, 0.7173, 0.01, 0.001, 0.001, 100],
        [5.571, 11.432, -32.000, 0.7198, 0.01, 0.001, 0.001, 100],
        [5.571, 11.432, -31.000, 0.7222, 0.01, 0.001, 0.001, 100],
        [5.570, 11.432, -30.000, 0.7247, 0.01, 0.001, 0.001, 100],
        [5.569, 11.432, -29.000, 0.7271, 0.01, 0.001, 0.001, 100],
        [5.568, 11.432, -28.000, 0.7296, 0.01, 0.001, 0.001, 100],
        [5.567, 11.432, -27.000, 0.732, 0.01, 0.001, 0.001, 100],
        [5.567, 11.432, -26.000, 0.7322, 0.01, 0.001, 0.001, 100],
        [5.567, 11.432, -25.000, 0.7324, 0.01, 0.001, 0.001, 100],
        [5.567, 11.432, -24.000, 0.7327, 0.01, 0.001, 0.001, 100],
        [5.567, 11.432, -23.000, 0.7329, 0.01, 0.001, 0.001, 100],
        [5.567, 11.432, -22.000, 0.7331, 0.01, 0.001, 0.001, 100],
        [5.567, 11.432, -21.000, 0.7333, 0.01, 0.001, 0.001, 100],
        [5.567, 11.432, -20.000, 0.7336, 0.01, 0.001, 0.001, 100],
        [5.567, 11.432, -19.000, 0.7338, 0.01, 0.001, 0.001, 100],
        [5.566, 11.432, -18.000, 0.734, 0.01, 0.001, 0.001, 100],
        [5.566, 11.432, -17.000, 0.734, 0.01, 0.001, 0.001, 100],
        [5.566, 11.432, -16.000, 0.734, 0.01, 0.001, 0.001, 100],
        [5.566, 11.432, -15.000, 0.734, 0.01, 0.001, 0.001, 100],
        [5.566, 11.432, -14.000, 0.734, 0.01, 0.001, 0.001, 100],
        [5.566, 11.432, -13.000, 0.734, 0.01, 0.001, 0.001, 100],
        [5.566, 11.432, -12.000, 0.734, 0.01, 0.001, 0.001, 100],
        [5.566, 11.432, -11.000, 0.734, 0.01, 0.001, 0.001, 100],
        [5.566, 11.432, -10.000, 0.734, 0.01, 0.001, 0.001, 100],
        [5.566, 11.432, -9.000, 0.734, 0.01, 0.001, 0.001, 100],
        [5.567, 11.432, -8.000, 0.7329, 0.01, 0.001, 0.001, 100],
        [5.568, 11.432, -7.000, 0.7318, 0.01, 0.001, 0.001, 100],
        [5.568, 11.432, -6.000, 0.7307, 0.01, 0.001, 0.001, 100],
        [5.569, 11.432, -5.000, 0.7296, 0.01, 0.001, 0.001, 100],
        [5.569, 11.432, -4.000, 0.7284, 0.01, 0.001, 0.001, 100],
        [5.570, 11.432, -3.000, 0.7273, 0.01, 0.001, 0.001, 100],
        [5.570, 11.432, -2.000, 0.7262, 0.01, 0.001, 0.001, 100],
        [5.571, 11.432, -1.000, 0.7251, 0.01, 0.001, 0.001, 100],
        [5.572, 11.432, 0.000, 0.724, 0.01, 0.001, 0.001, 100],
        [5.572, 11.432, 1.000, 0.7204, 0.01, 0.001, 0.001, 100],
        [5.572, 11.432, 2.000, 0.7169, 0.01, 0.001, 0.001, 100],
        [5.572, 11.432, 3.000, 0.7133, 0.01, 0.001, 0.001, 100],
        [5.572, 11.432, 4.000, 0.7098, 0.01, 0.001, 0.001, 100],
        [5.572, 11.432, 5.000, 0.7062, 0.01, 0.001, 0.001, 100],
        [5.572, 11.432, 6.000, 0.7027, 0.01, 0.001, 0.001, 100],
        [5.572, 11.432, 7.000, 0.6991, 0.01, 0.001, 0.001, 100],
        [5.572, 11.432, 8.000, 0.6956, 0.01, 0.001, 0.001, 100],
        [5.572, 11.432, 9.000, 0.692, 0.01, 0.001, 0.001, 100],
        [5.571, 11.432, 10.000, 0.6864, 0.01, 0.001, 0.001, 100],
        [5.571, 11.432, 11.000, 0.6809, 0.01, 0.001, 0.001, 100],
        [5.571, 11.432, 12.000, 0.6753, 0.01, 0.001, 0.001, 100],
        [5.570, 11.432, 13.000, 0.6698, 0.01, 0.001, 0.001, 100],
        [5.570, 11.432, 14.000, 0.6642, 0.01, 0.001, 0.001, 100],
        [5.569, 11.432, 15.000, 0.6587, 0.01, 0.001, 0.001, 100],
        [5.569, 11.432, 16.000, 0.6531, 0.01, 0.001, 0.001, 100],
        [5.569, 11.432, 17.000, 0.6476, 0.01, 0.001, 0.001, 100],
        [5.569, 11.432, 18.000, 0.642, 0.01, 0.001, 0.001, 100],
        [5.570, 11.432, 19.000, 0.6376, 0.01, 0.001, 0.001, 100],
        [5.571, 11.432, 20.000, 0.6331, 0.01, 0.001, 0.001, 100],
        [5.572, 11.432, 21.000, 0.6287, 0.01, 0.001, 0.001, 100],
        [5.573, 11.432, 22.000, 0.6242, 0.01, 0.001, 0.001, 100],
        [5.574, 11.432, 23.000, 0.6198, 0.01, 0.001, 0.001, 100],
        [5.575, 11.432, 24.000, 0.6153, 0.01, 0.001, 0.001, 100],
        [5.576, 11.432, 25.000, 0.6109, 0.01, 0.001, 0.001, 100],
        [5.577, 11.432, 26.000, 0.6064, 0.01, 0.001, 0.001, 100],
        [5.579, 11.432, 27.000, 0.602, 0.01, 0.001, 0.001, 100],
        [5.579, 11.432, 28.000, 0.5951, 0.01, 0.001, 0.001, 100],
        [5.580, 11.432, 29.000, 0.5882, 0.01, 0.001, 0.001, 100],
        [5.580, 11.432, 30.000, 0.5813, 0.01, 0.001, 0.001, 100],
        [5.581, 11.432, 31.000, 0.5744, 0.01, 0.001, 0.001, 100],
        [5.581, 11.432, 32.000, 0.5676, 0.01, 0.001, 0.001, 100],
        [5.582, 11.432, 33.000, 0.5607, 0.01, 0.001, 0.001, 100],
        [5.582, 11.432, 34.000, 0.5538, 0.01, 0.001, 0.001, 100],
        [5.583, 11.432, 35.000, 0.5469, 0.01, 0.001, 0.001, 100],
        [5.583, 11.432, 36.000, 0.54, 0.01, 0.001, 0.001, 100],
        [5.584, 11.432, 37.000, 0.5329, 0.01, 0.001, 0.001, 100],
        [5.585, 11.432, 38.000, 0.5258, 0.01, 0.001, 0.001, 100],
        [5.586, 11.432, 39.000, 0.5187, 0.01, 0.001, 0.001, 100],
        [5.587, 11.432, 40.000, 0.5116, 0.01, 0.001, 0.001, 100],
        [5.588, 11.432, 41.000, 0.5044, 0.01, 0.001, 0.001, 100],
        [5.589, 11.432, 42.000, 0.4973, 0.01, 0.001, 0.001, 100],
        [5.590, 11.432, 43.000, 0.4902, 0.01, 0.001, 0.001, 100],
        [5.591, 11.432, 44.000, 0.4831, 0.01, 0.001, 0.001, 100],
        [5.591, 11.432, 45.000, 0.476, 0.01, 0.001, 0.001, 100],
        [5.593, 11.432, 46.000, 0.468, 0.01, 0.001, 0.001, 100],
        [5.594, 11.432, 47.000, 0.46, 0.01, 0.001, 0.001, 100],
        [5.596, 11.432, 48.000, 0.452, 0.01, 0.001, 0.001, 100],
        [5.597, 11.432, 49.000, 0.444, 0.01, 0.001, 0.001, 100],
        [5.598, 11.432, 50.000, 0.436, 0.01, 0.001, 0.001, 100],
        [5.599, 11.432, 51.000, 0.428, 0.01, 0.001, 0.001, 100],
        [5.601, 11.432, 52.000, 0.42, 0.01, 0.001, 0.001, 100],
        [5.602, 11.432, 53.000, 0.412, 0.01, 0.001, 0.001, 100],
        [5.604, 11.432, 54.000, 0.404, 0.01, 0.001, 0.001, 100],
        [5.603, 11.432, 55.000, 0.4, 0.01, 0.001, 0.001, 100],
        [5.602, 11.432, 56.000, 0.396, 0.01, 0.001, 0.001, 100],
        [5.601, 11.432, 57.000, 0.392, 0.01, 0.001, 0.001, 100],
        [5.601, 11.432, 58.000, 0.388, 0.01, 0.001, 0.001, 100],
        [5.600, 11.432, 59.000, 0.384, 0.01, 0.001, 0.001, 100],
        [5.599, 11.432, 60.000, 0.38, 0.01, 0.001, 0.001, 100],
        [5.599, 11.432, 61.000, 0.376, 0.01, 0.001, 0.001, 100],
        [5.598, 11.432, 62.000, 0.372, 0.01, 0.001, 0.001, 100],
        [5.598, 11.432, 63.000, 0.368, 0.01, 0.001, 0.001, 100],
        [5.596, 11.432, 64.000, 0.3649, 0.01, 0.001, 0.001, 100],
        [5.594, 11.432, 65.000, 0.3618, 0.01, 0.001, 0.001, 100],
        [5.592, 11.432, 66.000, 0.3587, 0.01, 0.001, 0.001, 100],
        [5.590, 11.432, 67.000, 0.3556, 0.01, 0.001, 0.001, 100],
        [5.589, 11.432, 68.000, 0.3524, 0.01, 0.001, 0.001, 100],
        [5.587, 11.432, 69.000, 0.3493, 0.01, 0.001, 0.001, 100],
        [5.585, 11.432, 70.000, 0.3462, 0.01, 0.001, 0.001, 100],
        [5.583, 11.432, 71.000, 0.3431, 0.01, 0.001, 0.001, 100],
        [5.582, 11.432, 72.000, 0.34, 0.01, 0.001, 0.001, 100],
        [5.578, 11.432, 73.000, 0.3378, 0.01, 0.001, 0.001, 100],
        [5.575, 11.432, 74.000, 0.3356, 0.01, 0.001, 0.001, 100],
        [5.572, 11.432, 75.000, 0.3333, 0.01, 0.001, 0.001, 100],
        [5.569, 11.432, 76.000, 0.3311, 0.01, 0.001, 0.001, 100],
        [5.566, 11.432, 77.000, 0.3289, 0.01, 0.001, 0.001, 100],
        [5.563, 11.432, 78.000, 0.3267, 0.01, 0.001, 0.001, 100],
        [5.560, 11.432, 79.000, 0.3244, 0.01, 0.001, 0.001, 100],
        [5.557, 11.432, 80.000, 0.3222, 0.01, 0.001, 0.001, 100],
        [5.553, 11.432, 81.000, 0.32, 0.01, 0.001, 0.001, 100],
        [5.551, 11.432, 82.000, 0.3193, 0.01, 0.001, 0.001, 100],
        [5.549, 11.432, 83.000, 0.3187, 0.01, 0.001, 0.001, 100],
        [5.546, 11.432, 84.000, 0.318, 0.01, 0.001, 0.001, 100],
        [5.544, 11.432, 85.000, 0.3173, 0.01, 0.001, 0.001, 100],
        [5.542, 11.432, 86.000, 0.3167, 0.01, 0.001, 0.001, 100],
        [5.540, 11.432, 87.000, 0.316, 0.01, 0.001, 0.001, 100],
        [5.537, 11.432, 88.000, 0.3153, 0.01, 0.001, 0.001, 100],
        [5.535, 11.432, 89.000, 0.3147, 0.01, 0.001, 0.001, 100],
        [5.532, 11.432, 90.000, 0.314, 0.01, 0.001, 0.001, 100],

]

pvs = ['2xfm:m24.VAL', '2xfm:m13.VAL', '2xfm:m58.VAL', '2xfm:FscanH.P1WD',
       '2xfm:Fscan1.P1WD', '2xfm:FscanH.P1SI', '2xfm:Fscan1.P1SI', '2xfm:Flyscans:Setup:DwellTime.VAL']

sample_x = PV('2xfm:m24.VAL')
sample_x_rbv = PV('2xfm:m24.RBV')
sample_y = PV('2xfm:m13.VAL')
sample_y_rbv = PV('2xfm:m13.RBV')

print('Batchscan starts')

for batch_num, scan in enumerate(scans):

    print('entering scan parameters for scan #{0:d}'.format(batch_num + 1))
    for i, pvs1 in enumerate(pvs):
        print ('Setting %s' % pvs1)
        caput(pvs1, scans[batch_num][i])
        time.sleep(1.)

    # check whether the motors have moved to the requested position
    print('checking whether motors are in position')
    ready = abs(sample_x_rbv.get() - sample_x.get()) < 0.1 and abs(sample_y_rbv.get() - sample_y.get()) < 0.1
    while not ready:
        print('\t Motors are not ready')
        sample_x.put(sample_x.get())
        sample_y.put(sample_y.get())
        time.sleep(3.)
        ready = abs(sample_x_rbv.get() - sample_x.get()) < 0.1 and abs(
            sample_y_rbv.get() - sample_y.get()) < 0.1
    print('\t Motors are ready now!')

    caput('2xfm:Fscan1.EXSC', 1)
    time.sleep(1.)
    done = False
    print('Checking every 10 sec for scan to complete')

    while not done:
        done = caget('2xfm:Fscan1.EXSC') == 0
        print('\t Batch {0:d}/{1:d} scan is ongoing'.format(batch_num + 1, len(scans)))
        time.sleep(10.)

print('Completeted. Congratulations!')
